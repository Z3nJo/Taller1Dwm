<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pedido Confirmado</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="Style_paginas/confirmacion.css">
</head>
<body>
  <div class="container my-5">
    <div class="row justify-content-center">
      <div class="col-md-8 col-lg-6">
        <div class="card text-center shadow-sm p-4">
          <div class="mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="#28a745" class="bi bi-check-circle" viewBox="0 0 16 16">
              <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM7 10.5l4-4L10.5 5l-3.5 3.5L5.5 7 4 8.5l3 3z"/>
            </svg>
          </div>

          <h2 class="mb-3">¡Pedido Confirmado!</h2>
          <p id="nombre-cliente" class="fs-5"></p>
          <p id="mensaje-pedido" class="fs-6"></p>
          <p id="metodo-pago" class="text-muted"></p>

          <h4 class="mt-4">Resumen del Pedido</h4>
          <ul id="lista-productos" class="list-group text-start mt-3 mb-4"></ul>
          <h5>Total: <strong id="total-compra"></strong></h5>

          <p class="text-success mt-3 fw-semibold">Gracias por tu compra 😊</p>
          <div class="d-flex justify-content-center gap-3 mt-4 flex-wrap">
            <a href="catalogo.html" class="btn btn-primary btn-lg">Volver al Catálogo</a>
            <a href="boletaExample.html" class="btn btn-secondary btn-lg">Ver Boleta</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- Datos del pedido ---
    const productos = JSON.parse(sessionStorage.getItem("productosCompra")) || [];
    const monto = sessionStorage.getItem("montoPagar") || "$0";
    const metodoPago = sessionStorage.getItem("metodoPago") || "N/A";
    const usuarioActivo = JSON.parse(sessionStorage.getItem("usuarioActivo")) || { nombre: "Invitado", correo: "", direccion: "" };
    const nombreCliente = usuarioActivo.nombre || "Cliente desconocido";
    const correoCliente = usuarioActivo.correo || "";
    const direccionCliente = usuarioActivo.direccion || "Dirección no disponible"; // <-- Dirección

    // Mostrar datos en la interfaz
    document.getElementById("nombre-cliente").textContent = `Cliente: ${nombreCliente}`;
    document.getElementById("metodo-pago").textContent = `Método de pago: ${metodoPago}`;
    document.getElementById("total-compra").textContent = monto;

    // Si quieres mostrar dirección en la página, descomenta esta línea y agrega un <p id="direccion-cliente"></p> en el HTML
    // document.getElementById("direccion-cliente").textContent = `Dirección: ${direccionCliente}`;

    const listaProductos = document.getElementById("lista-productos");
    listaProductos.innerHTML = "";
    if (productos.length > 0) {
      productos.forEach(p => {
        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        const cantidad = p.cantidad ? `x${p.cantidad}` : "";
        li.innerHTML = `<span>${p.nombre} ${cantidad}</span><span>$${(p.precioUnitario * (p.cantidad || 1)).toLocaleString("es-CL")}</span>`;
        listaProductos.appendChild(li);
      });
    } else {
      listaProductos.innerHTML = "<li class='list-group-item'>No hay productos disponibles</li>";
    }

    // --- Crear ID de pedido ---
    const idPedido = "PED" + Date.now();
    const fecha = new Date().toLocaleString("es-CL");

    // --- Crear objeto de pedido completo ---
    const nuevoPedido = {
      id: idPedido,
      fecha: fecha,
      productos: productos,
      total: productos.reduce((sum, p) => sum + (p.precioUnitario * (p.cantidad || 1)), 0),
      metodoPago: metodoPago,
      cliente: nombreCliente,
      correo: correoCliente,
      direccion: direccionCliente, // <-- Se guarda la dirección
      estado: "Pendiente"
    };

    // --- Guardar en historial por usuario ---
    const historialUsuarios = JSON.parse(localStorage.getItem("historialUsuarios")) || {};
    if (!historialUsuarios[nombreCliente]) historialUsuarios[nombreCliente] = [];
    historialUsuarios[nombreCliente].push(nuevoPedido);
    localStorage.setItem("historialUsuarios", JSON.stringify(historialUsuarios));

    // --- Guardar pedido para la boleta ---
    sessionStorage.setItem("pedidoBoleta", JSON.stringify(nuevoPedido));

    // --- Limpiar carrito solo si viene del flujo normal ---
    const activeOrder = JSON.parse(sessionStorage.getItem("activeOrder"));
    if (!activeOrder) {
      localStorage.removeItem("carrito");
    }
    sessionStorage.removeItem("productosCompra");
    sessionStorage.removeItem("montoPagar");
    sessionStorage.removeItem("metodoPago");

    // --- Mensaje de confirmación ---
    document.getElementById("mensaje-pedido").textContent = `Tu pedido ha sido registrado con éxito. Número de pedido: ${idPedido}`;
  </script>
</body>
</html>